# 连接拒绝错误问题分析与解决方案

## 问题概述

通过分析代码库和错误日志，我们发现主要问题是代理服务器在处理外部API请求时出现的连接拒绝错误（ECONNREFUSED）以及相关的网络连接问题。这些错误导致应用程序无法正常获取数据，影响用户体验。

## 问题分析

通过对`api.js`和`static-server.js`等核心文件的详细分析，我们发现以下几个关键问题：

1. **代理请求错误处理不完善**：原代码没有对不同类型的网络错误（如连接拒绝、超时、DNS解析失败等）进行区分处理
2. **缺乏详细的日志记录**：难以追踪和调试具体的连接问题
3. **请求超时设置过短**：10秒的超时时间对于某些网络环境可能不足
4. **代理认证机制需要优化**：时间戳验证逻辑缺失
5. **错误响应格式不一致**：部分返回HTML，部分返回JSON，不利于前端统一处理
6. **缺乏健康检查机制**：无法监控服务器状态

## 实施的解决方案

### 1. 前端改进 (`api.js`)

- **增强fetchWithRetry函数**：
  - 添加请求ID跟踪
  - 调整重试策略和超时时间
  - 增加详细日志记录
  
- **扩展错误类型识别**：
  - 在getSpecificErrorMessage函数中增加对更多错误类型的识别
  - 提供更具体的错误提示信息

- **优化代理请求逻辑**：
  - 添加URL验证
  - 改进错误处理和重试机制

### 2. 服务器端改进 (`static-server.js`)

- **增强代理请求处理**：
  - 添加请求ID跟踪
  - 实现错误类型区分处理（连接拒绝、超时、DNS解析失败等）
  - 增加详细的日志记录
  - 优化请求头设置
  - 延长超时时间至20秒

- **改进认证机制**：
  - 添加时间戳验证，防止长时间有效的认证
  - 增强安全性检查

- **添加安全特性**：
  - 防止路径遍历攻击
  - 添加CORS支持
  - 统一JSON格式的错误响应

- **添加监控和维护功能**：
  - 健康检查端点
  - 优雅关闭处理
  - 未捕获异常处理
  - 调试模式支持

### 3. 配置文件优化

- 创建`.env.example`配置文件示例
- 支持DEBUG模式开关
- 提供清晰的配置说明

## 使用说明

### 1. 配置环境变量

1. 复制`.env.example`文件为`.env`
2. 根据需要修改配置参数：
   - `PORT`: 服务器端口（默认8787）
   - `DEBUG`: 是否开启调试模式（true/false）
   - `PASSWORD`: 设置代理认证密码（请设置强密码）
   - `VERSION`: 应用版本号

### 2. 启动服务器

```bash
node static-server.js
```

### 3. 健康检查

启动后可访问以下地址检查服务器状态：
```
http://localhost:8787/health
```

### 4. 错误排查

- 开启DEBUG模式可查看详细日志：
  ```
  DEBUG=true node static-server.js
  ```
- 服务器会为每个请求生成唯一ID，便于追踪请求流程
- 错误日志会包含具体的错误代码和原因

## 常见错误处理指南

1. **连接被拒绝 (ECONNREFUSED)**
   - 可能原因：目标服务器不可用或网络限制
   - 建议：检查目标服务器状态，确认网络连接正常

2. **域名解析失败 (ENOTFOUND)**
   - 可能原因：域名不存在或DNS问题
   - 建议：验证域名是否正确，检查DNS设置

3. **连接超时 (ETIMEDOUT)**
   - 可能原因：网络延迟或服务器响应慢
   - 建议：检查网络连接质量，考虑增加超时时间

4. **代理请求未授权**
   - 可能原因：密码不匹配或时间戳过期
   - 建议：确认密码配置正确，重新生成认证参数

## 监控与维护

- 定期检查服务器日志，关注频繁出现的错误
- 使用健康检查端点监控服务器状态
- 在生产环境中建议配置适当的监控告警
- 定期更新依赖包以获取安全更新

## 性能优化建议

- 考虑添加请求缓存机制，减少重复请求
- 对于高流量应用，建议使用更强大的代理服务器（如Nginx）
- 实现请求限流，防止滥用
- 考虑使用连接池管理并发连接